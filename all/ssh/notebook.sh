#!/usr/bin/env zsh

source ${HOME}/.zshrc

print_usage() {
    echo "${COLOR_RED}Usage: notebook ( open [hostname] | start venvname)${COLOR_OFF}" 1>&2;
}

if [[ $# -ne 2 && $# -ne 1 ]]; then
    print_usage;
    return 1;
fi

# =====================================================================================================================
# ================================================ start ==============================================================
# =====================================================================================================================
if [[ $1 == "start" ]]; then
    if [[ $# -eq 2 ]]; then
        workon $2;
    fi

    # =================================================================================================================
    # =========================================== Darwin ==============================================================
    # =================================================================================================================
    if [[ $is_darwin == true ]]; then
        jupyter notebook --port=${IPYTHON_PORT};
    # =================================================================================================================
    # ============================================= Linux =============================================================
    # =================================================================================================================
    elif [[ $is_linux == true ]]; then
        (sleep 2 && notebook open) &  # async call for host to forward ports and open in default browser
        jupyter notebook --certfile=${HOME}/projects/dots/all/security/mycert.pem \
            --no-browser --port=${IPYTHON_PORT};
    # =================================================================================================================
    # =========================================== Unknown host ========================================================
    # =================================================================================================================
    else
        echo "${COLOR_RED}Unknown host $(uname)${COLOR_OFF}";
    fi

# =====================================================================================================================
# ================================================ open ===============================================================
# =====================================================================================================================
elif [[ $1 == "open" ]]; then
    # =================================================================================================================
    # =========================================== Darwin ==============================================================
    # =================================================================================================================
    if [[ $is_darwin == true ]]; then
        if [[ $# -eq 1 ]]; then
            open https://localhost:${IPYTHON_PORT};
        elif [[ $# -eq 2 ]]; then
            if [[ $2 == '--read-hostname-from-pipe' ]];then
                echo "${COLOR_CYAN}Reading hostname from pipe ${COLOR_OFF}";
                read hostname;  # read hostname from port pipe
                echo "${COLOR_CYAN}Server hostname is ${hostname}${COLOR_OFF}";
            else
                hostname=$2;
            fi
            # kill existing connection.
            ps aux \
                | grep "ssh -q -N -f -L localhost:${IPYTHON_PORT}:localhost:${IPYTHON_PORT}" \
                | grep -v "grep" \
                | tr -s " " \
                | cut -d " " -f2 \
                | xargs -I {} kill -9 {};
            ssh -q -N -f -L localhost:${IPYTHON_PORT}:localhost:${IPYTHON_PORT} ${hostname};
            notebook open;
        else
            print_usage;
            return 1;
        fi
    # =================================================================================================================
    # ============================================= Linux =============================================================
    # =================================================================================================================
    elif [[ $is_linux == true ]]; then
        if [[ $# -ne 1 ]]; then
            print_usage;
            return 1;
        fi

        echo "${COLOR_CYAN}Trying to open notebook on local machine${COLOR_OFF}";
        # write hostname to port, then 'read-from-port | notebook tunnel --read-hostname-from-pipe' will be called
        echo ${HOST} | (nc localhost 2227 & pid=$! && sleep 2 && kill -9 $pid);
    # =================================================================================================================
    # =========================================== Unknown host ========================================================
    # =================================================================================================================
    else
        echo "${COLOR_RED}Unknown host $(uname)${COLOR_OFF}";
    fi
# =====================================================================================================================
# ============================================ Unknown command ========================================================
# =====================================================================================================================
else
    print_usage;
    return 1;
fi
